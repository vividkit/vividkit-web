---
import { useTranslations } from '@/i18n/utils';
import { getLangFromUrl, useTranslatedPath, type Language } from '@/i18n';

interface Props {
  activeTab: 'what-is-claudekit' | 'cli' | 'ccs' | 'happy-ccs' | 'token-tips' | 'workflows' | 'flowchart' | 'commands' | 'uiux' | 'session-recovery' | 'permissions' | 'fix-logs' | 'hooks' | 'promotions';
  lang?: Language;
}

const { activeTab, lang } = Astro.props;

// Get language from URL if not provided
const currentLang = lang || getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
const translatePath = useTranslatedPath(currentLang);

// Navigation items organized by sections
const navSections = [
  {
    id: 'getting-started',
    label: t('guides.sections.getting_started'),
    items: [
      {
        id: 'what-is-claudekit',
        label: t('guides.what_is_claudekit.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>`,
        href: '/guides/what-is-claudekit',
      },
      {
        id: 'cli',
        label: t('guides.cli.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>`,
        href: '/guides/cli',
      },
    ],
  },
  {
    id: 'core-features',
    label: t('guides.sections.core_features'),
    items: [
      {
        id: 'commands',
        label: t('guides.commands.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>`,
        href: '/guides/commands',
      },
      {
        id: 'flowchart',
        label: t('guides.flowchart.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>`,
        href: '/guides/flowchart',
      },
      {
        id: 'workflows',
        label: t('guides.workflows.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>`,
        href: '/guides/workflows',
      },
    ],
  },
  {
    id: 'multi-provider',
    label: t('guides.sections.multi_provider'),
    items: [
      {
        id: 'ccs',
        label: t('guides.ccs.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>`,
        href: '/guides/ccs',
      },
      {
        id: 'happy-ccs',
        label: t('guides.happy_ccs.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>`,
        href: '/guides/happy-ccs',
      },
    ],
  },
  {
    id: 'session-mgmt',
    label: t('guides.sections.session_management'),
    items: [
      {
        id: 'session-recovery',
        label: t('guides.session_recovery.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>`,
        href: '/guides/session-recovery',
      },
    ],
  },
  {
    id: 'optimization',
    label: t('guides.sections.optimization'),
    items: [

      {
        id: 'uiux',
        label: t('guides.uiux.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.396 3.395c.98-.18 1.933-.414 2.855-.693l1.955-1.956a8.827 8.827 0 01-4.186-3.416 19.584 19.584 0 00-4.218 4.218l-1.956 1.956a2.625 2.625 0 002.394 2.883l.003-.003h-.002z" /></svg>`,
        href: '/guides/uiux',
      },
    ],
  },
  {
    id: 'configuration',
    label: t('guides.sections.configuration'),
    items: [
      {
        id: 'permissions',
        label: t('guides.permissions.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>`,
        href: '/guides/permissions',
      },
      {
        id: 'hooks',
        label: t('guides.custom_hooks.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /></svg>`,
        href: '/guides/hooks',
      },
    ],
  },
  {
    id: 'troubleshooting',
    label: t('guides.sections.troubleshooting'),
    items: [
      {
        id: 'fix-logs',
        label: t('guides.fix_logs.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.703-.127 1.5.168 2.37.91 2.942 1.953-.617 1.05-1.46 1.907-2.478 2.486-.894.514-1.897.666-2.656.353-.263-.109-.526-.263-.787-.456-.514-.383-1.014-.863-1.487-1.436-.46-.56-.842-1.12-1.166-1.666-.23-.393-.414-.77-.55-1.117-.184-.467-.185-.947-.07-1.4l.267-.267a2.59 2.59 0 001.375-1.2l1.636-3.72a2.493 2.493 0 013.237-1.272l.462.197c1.192.51 1.69 1.933 1.096 3.09l-1.927 3.757a2.553 2.553 0 00-.236 1.482z" /></svg>`,
        href: '/guides/fix-logs',
      },
    ],
  },
  {
    id: 'resources',
    label: t('guides.sections.resources'),
    items: [
      {
        id: 'promotions',
        label: t('guides.promotions.title'),
        icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" /></svg>`,
        href: '/guides/promotions',
      },
    ],
  },
];

// Flatten items for mobile view
const flatNavItems = navSections.flatMap(section => section.items);
---

<style>
  /* Custom scrollbar for sidebar */
  aside::-webkit-scrollbar {
    width: 5px;
  }
  aside::-webkit-scrollbar-track {
    background: transparent;
  }
  aside::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.3);
    border-radius: 20px;
  }

  /* Hide scrollbar for mobile nav */
  .mobile-nav-scroll::-webkit-scrollbar {
    display: none;
  }
  .mobile-nav-scroll {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<!-- Sidebar Navigation (Desktop) -->
<aside class="hidden lg:block sticky top-32 self-start max-h-[calc(100vh-10rem)] overflow-y-auto rounded-2xl glass-card border border-slate-200/50 dark:border-slate-800/50 backdrop-blur-md">
  <div class="p-4">
    <!-- Sidebar Header -->
    <div class="px-4 mb-4 mt-2">
      <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">
        {t('guides.sidebar.title')}
      </h2>
    </div>

    <!-- Navigation Items by Section -->
    <nav class="space-y-4">
      {navSections.map((section) => (
        <div>
          <!-- Section Header -->
          <div class="px-4 py-1.5 text-[10px] font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider">
            {section.label}
          </div>
          <!-- Section Items -->
          <div class="space-y-0.5">
            {section.items.map((item) => (
              <a
                href={translatePath(item.href)}
                class={`group flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 ${
                  activeTab === item.id
                    ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 shadow-sm'
                    : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-slate-200'
                }`}
              >
                <span class={`text-lg transition-transform duration-200 ${activeTab === item.id ? 'scale-110' : 'group-hover:scale-110'}`}>
                  <Fragment set:html={item.icon} />
                </span>
                <span>
                  {item.label}
                </span>
                {activeTab === item.id && (
                  <div class="ml-auto w-1.5 h-1.5 rounded-full bg-blue-500 dark:bg-blue-400 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></div>
                )}
              </a>
            ))}
          </div>
        </div>
      ))}
    </nav>

  </div>
</aside>

<!-- Mobile Navigation (Sticky Top) -->
<div class="lg:hidden sticky top-20 z-40 -mx-4 sm:-mx-6 lg:-mx-8 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-y border-slate-200/50 dark:border-slate-800/50 px-4 sm:px-6 lg:px-8 py-3 mb-8">
  <div class="mobile-nav-scroll flex gap-2 overflow-x-auto no-scrollbar">
    {flatNavItems.map((item) => (
      <a
        href={translatePath(item.href)}
        class={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all ${
          activeTab === item.id
            ? 'bg-blue-600 text-white shadow-md shadow-blue-500/20'
            : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
        }`}
      >
        <span><Fragment set:html={item.icon} /></span>
        {item.label}
      </a>
    ))}
  </div>
</div>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .mask-gradient {
    -webkit-mask-image: linear-gradient(to right, black 95%, transparent 100%);
    mask-image: linear-gradient(to right, black 95%, transparent 100%);
  }
</style>
